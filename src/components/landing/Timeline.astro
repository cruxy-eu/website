---
import { getCollection, render } from 'astro:content';
import { MaskedIcon } from "@cruxy/components";
import { Icon } from "astro-icon/components";
// Get all timeline entries
const collection = await getCollection('timeline');
// Render all items upfront
const rendered = await Promise.all(
    collection.map(async (item) => {
        const { Content } = await render(item);
        const IconComponent = item.data.icon?.startsWith("mdi:") ? Icon : MaskedIcon;
        return {
            data: item.data,
            Content,
            IconComponent
        };
    })
)
const timeline = rendered.sort((a, b) => a.data.order - b.data.order);
---
<style>
    .timeline-item {
        opacity: 0;
        transform: translateY(30px);
        transition: opacity 0.3s ease-out, transform 0.3s ease-out;
    }

    .timeline-item.visible {
        opacity: 1;
        transform: translateY(0);
    }

    .line {
        opacity: 0;
        transform: scaleY(0);
        transform-origin: top;
        transition: opacity 0.6s ease-out, transform 0.6s ease-out;
    }

    .line.visible {
        opacity: 1;
        transform: scaleY(1);
    }

    @media (prefers-reduced-motion: reduce) {
        .timeline-item,
        .line {
            transition: none;
            transform: none;
            opacity: 1;
        }
    }
</style>

<div class="relative">
    <div>
    {
        timeline.map((item) => (
            <div class="timeline-item relative flex items-start gap-6">
                <div class="line absolute left-6 top-12 bottom-0 w-0.5 bg-primary"></div>

                <!-- Timeline dot and icon -->
                <div class="relative z-10 flex-shrink-0">
                    <div class="w-12 h-12 bg-primary rounded-full flex items-center justify-center">
                        <item.IconComponent name={item.data.icon} class="w-12 h-12 text-background" size="32px"/>
                    </div>
                </div>
                <!-- Content -->
                <div class="flex-1 min-w-0 pb-8 pt-2">
                    <div class="flex items-start justify-between gap-2 sm:gap-4 mb-2">
                        <div class="flex-1 min-w-0">
                            <h3 class="text-xl font-bold text-foreground overflow-hidden text-ellipsis">
                                <span>{item.data.entity}</span>
                            </h3>
                            <div class="font-medium text-sm italic text-muted-foreground mt-1">
                                // {item.data.location}
                            </div>
                        </div>
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-primary text-background font-semibold whitespace-nowrap flex-shrink-0">
                            {item.data.year}
                        </span>
                    </div>
                    <div class="text-muted-foreground leading-relaxed">
                        <item.Content />
                    </div>
                    {item.data.tags && item.data.tags.length > 0 && (
                        <div class="flex flex-wrap gap-2 mt-3">
                            {item.data.tags.map((tag) => (
                                <span class="inline-flex items-center rounded-md bg-orange-400/10 px-2 py-1 text-xs font-medium text-orange-500 inset-ring inset-ring-orange-400/20">
                                    {tag}
                                </span>
                            ))}
                        </div>
                    )}
                </div>
            </div>
        ))
    }

    <!-- Call to Action Timeline Item -->
    <div class="timeline-item relative flex items-start gap-6">
        <!-- Timeline dot and icon -->
        <div class="relative z-10 flex-shrink-0">
            <div class="w-12 h-12 bg-primary/20 border-2 border-primary border-dashed rounded-full flex items-center justify-center">
                <Icon name="mdi:plus" class="w-6 h-6 text-primary"/>
            </div>
        </div>
        <!-- Content -->
        <div class="flex-1 min-w-0 pb-8 pt-2">
            <div class="flex items-start justify-between mb-2">
                <div class="flex-1 min-w-0">
                    <h3 class="text-xl font-bold text-foreground overflow-hidden text-ellipsis">
                        <span>Your Project</span>
                    </h3>
                    <div class="font-medium text-sm italic text-muted-foreground mt-1">
                        Let's work together
                    </div>
                </div>
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-primary/20 text-primary font-semibold whitespace-nowrap flex-shrink-0">
                    Next?
                </span>
            </div>
            <div class="text-muted-foreground leading-relaxed mb-4">
                Have an exciting project in mind? I'd love to hear about it and explore how we can work together to bring your ideas to life.
            </div>
            <a href="/contact" class="inline-flex items-center gap-2 px-4 py-2 bg-primary text-background rounded-lg font-medium hover:bg-primary/90 transition-colors">
                Get in touch
                <Icon name="mdi:arrow-right" class="w-4 h-4"/>
            </a>
        </div>
    </div>
    </div>
</div>

<script>
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    // Skip all JavaScript animations if user prefers reduced motion
    if (prefersReducedMotion) {
        // CSS will handle making everything visible
    } else {
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };

        let animationQueue = [];
        let isAnimating = false;

        const animateNext = () => {
            if (animationQueue.length === 0) {
                isAnimating = false;
                return;
            }

            isAnimating = true;
            const item = animationQueue.shift();

            item.classList.add('visible');

            // Make the PREVIOUS item's line visible
            const prevItem = item.previousElementSibling;
            if (prevItem && prevItem.classList.contains('timeline-item')) {
                const prevLine = prevItem.querySelector('.line');
                if (prevLine) {
                    prevLine.classList.add('visible');
                }
            }

            // Wait for animation to complete before next item
            setTimeout(animateNext, 300);
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const item = entry.target;

                    // Add to queue if not already visible and not in queue
                    if (!item.classList.contains('visible') && !animationQueue.includes(item)) {
                        animationQueue.push(item);

                        // Start animation if not already running
                        if (!isAnimating) {
                            animateNext();
                        }
                    }

                    observer.unobserve(entry.target);
                }
            });
        }, observerOptions);

        document.querySelectorAll('.timeline-item').forEach(item => {
            observer.observe(item);
        });

        document.addEventListener("astro:after-swap", () => {
            animationQueue = [];
            isAnimating = false;
            document.querySelectorAll('.timeline-item').forEach(item => {
                observer.observe(item);
            });
        });
    }
</script>
